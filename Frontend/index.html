{% extends "base.html" %}

{% block title %}Analysts Ranking{% endblock %}
{% block forms %}
<form action="/generate_data" method="POST">
    <label for="start-date">Start Date:</label>
    <input type="date" id="start-date" name="start-date" value="{{ form_values['start-date'] }}" required>
    
    <label for="end-date">End Date:</label>
    <input type="date" id="end-date" name="end-date" value="{{ form_values['end-date'] }}" required>
    
    <label for="period">Period:</label>
    <select id="period" name="period">
        {% for option in dropdown_options['period'] %}
        <option value="{{ option }}" {% if form_values['period'] == option %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
    </select>

    <label for="analyst">Analyst:</label>
    <select id="analyst" name="analyst">
        {% for option in dropdown_options['analyst'] %}
        <option value="{{ option }}" {% if form_values['analyst'] == option %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
    </select>
    
    <input type="submit" value="Generate" id="submit-button">
</form>

<form id="sort-form" method="POST" action="/sort_table">
    <label for="sort-by">Sort By:</label>
    <select name="sort_by" id="sort-by">
        <option value="Success %">Success %</option>
        <option value="Total Calls in Period: ">Total Calls</option>
        <option value="Total Successes in the period: ">Total Successes</option>
    </select>
    <button type="submit" id="submit-button">Sort</button>
</form>
{% endblock %}   

{% block df %}
<h2>DataFrame Display</h2>
<div class="container">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Analyst</th>
                <th>Total Calls in Period</th>
                <th>Total Successes in the period</th>
                <th>Success %</th>
                <th>Number of unique stocks</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for index, row in df.iterrows() %}
            <tr>
                <th>{{ row.name }}</tb>
                <td>{{ row['Total Calls in Period: '] }}</td>
                <td>{{ row['Total Successes in the period: '] }}</td>
                <td>{{ row['Success %'] }}</td>
                <td>{{ row['No. of Unique Stocks'] }}</td>
                <td><button class="eye-button" data-toggle="modal" data-target="#detailsModal" data-analyst="{{ row.name }}">&#128065;</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="analyst-details"></div>
    </div>
</div>

<script>
    // JavaScript for modal functionality
    document.addEventListener('DOMContentLoaded', function () {
        const eyeButtons = document.querySelectorAll('.eye-button');
        const modal = document.getElementById('detailsModal');
        const closeBtn = modal.querySelector('.close');

        eyeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const analyst = this.getAttribute('data-analyst');
                fetch(`/get_analyst_details?analyst=${analyst}`)
                    .then(response => response.json())
                    .then(data => {
                        const analystDetails = document.getElementById('analyst-details');
                        analystDetails.innerHTML = data.html;
                        modal.style.display = 'block';
                    });
            });
        });

        // Close modal on close button click
        closeBtn.addEventListener('click', function () {
            modal.style.display = 'none';
        });

        // Close modal on outside click
        window.addEventListener('click', function (event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>
{% endblock %}
